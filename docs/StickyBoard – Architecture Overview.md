# StickyBoard — Unified Data & Storage Specification

**Last updated:** October 2025
 **Scope:** Cross-database communication and canonical JSON definitions (PostgreSQL ↔ SQLite ↔ Client)

------

## 0) Purpose

This document defines how data is structured, shared, and synchronized across all layers of the StickyBoard ecosystem. It focuses on the **logical entities**, their **relationships**, and the **canonical JSON bridge** that unifies:

- **PostgreSQL (Server Authority)** — Main persistence layer for multi-user collaboration, workers, and sync aggregation.
- **SQLite (Client Mirror)** — Local cache optimized for offline-first operation and delta synchronization.
- **Canonical JSON** — Unified payload format used by both to exchange entities during sync, exports, and imports.

Implementation details (indexes, triggers, enum creation, etc.) are intentionally omitted to emphasize data flow and integration.

------

## 1) Data Visibility Overview

| Domain                        | Entity                     | Shared (Sync) | Server Only | Client Only | Description                                              |
| ----------------------------- | -------------------------- | ------------- | ----------- | ----------- | -------------------------------------------------------- |
| **Auth & Identity**           | `users`                    | ✅             |             |             | Profile, preferences, display info.                      |
|                               | `auth_users`               |               | ✅           |             | Internal credentials (hashed passwords, roles).          |
| **Boards**                    | `boards`                   | ✅             |             |             | Workspace containers owned or shared between users.      |
|                               | `permissions`              | ✅             |             |             | Collaboration roles for shared boards.                   |
| **Structure**                 | `sections`                 | ✅             |             |             | Board subdivisions (lanes/categories).                   |
|                               | `tabs`                     | ✅             |             |             | Logical or visual layouts inside sections.               |
|                               | `cards`                    | ✅             |             |             | Primary editable content (tasks, notes, events).         |
|                               | `links`                    | ✅             |             |             | Relationships between cards (dependencies, references).  |
| **Metadata**                  | `tags`                     | ✅             |             |             | Shared tagging vocabulary for filtering and grouping.    |
|                               | `card_tags`                | ✅             |             |             | Many-to-many link between cards and tags.                |
|                               | `files`                    | ✅             |             |             | Metadata for attachments (binary stored externally).     |
| **Automation & Intelligence** | `rules`                    | ✅             |             |             | Declarative automations triggered by operations.         |
|                               | `clusters`                 | ✅             |             |             | Computed groups of cards or sections.                    |
|                               | `cluster_members`          | ✅             |             |             | Cards included in a given cluster.                       |
| **Activity / Audit**          | `activities`               | ⬜ Partial     | ✅           |             | Event and change log for boards, cards, and automations. |
| **Sync Engine**               | `operations`               | ✅             |             |             | Log of all entity changes across devices.                |
| **Background System**         | `worker_jobs`              |               | ✅           |             | Task queue for workers (rule evaluation, cleanup).       |
| **Client Local Data**         | (cached views, user prefs) |               |             | ✅           | Local app settings, unsynced drafts, transient state.    |

------

## 2) Entity Hierarchy

```
User
 └── Boards
      ├── Permissions (shared access)
      ├── Sections
      │    └── Tabs
      │         └── Cards
      │              ├── Tags
      │              ├── Links (to other cards)
      │              └── Files
      ├── Rules → Clusters → ClusterMembers
      └── Activities (generated by user or workers)
```

Workers operate on the same hierarchy, reading from `operations`, `rules`, and `clusters` to compute derived data.

------

## 3) Database Roles

### **PostgreSQL (Server Authority)**

- Stores the full relational model.
- Hosts internal-only tables (`auth_users`, `worker_jobs`, etc.).
- Maintains referential integrity and timestamp updates.
- Generates sync feeds (`operations`) for all connected clients.
- Used by both API and workers.

### **SQLite (Client Mirror)**  (see full schema at  the bottom)

- Stores a lightweight mirror of sync-eligible entities only.
- Retains local `operations` created offline until upload.
- Uses JSON columns for flexible schemas.
- Includes local-only preferences or caches (`local_state`, `fts_cards`, etc.).
- Enforces simplified foreign keys without triggers.

------

## 4) Canonical JSON Bridge

All synchronized entities are exchanged via **canonical JSON documents**.
 These are consistent across PostgreSQL, SQLite, and client apps, and represent the exact data shape in REST or WebSocket payloads.

### **4.1 Entity Base Fields**

Every synced entity inherits the following structure:

```json
{
  "id": "uuid",
  "createdAt": "2025-10-24T12:00:00Z",
  "updatedAt": "2025-10-24T12:00:00Z",
  "boardId": "uuid?", // present for board-linked entities
  "deleted": false // soft deletion flag (not stored in DB, client-only transient)
}
```

### **4.2 Users**

```json
{
  "id": "uuid",
  "email": "user@example.com",
  "displayName": "Alex Emond",
  "avatarUri": null,
  "prefs": { "theme": "dark", "lang": "en" },
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.3 Boards**

```json
{
  "id": "uuid",
  "ownerId": "uuid",
  "title": "Development Roadmap",
  "visibility": "shared",
  "theme": { "color": "slate", "accent": "blue" },
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.4 Sections**

```json
{
  "id": "uuid",
  "boardId": "uuid",
  "title": "Backlog",
  "position": 1,
  "layoutMeta": { "columns": 1 },
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.5 Tabs**

```json
{
  "id": "uuid",
  "boardId": "uuid",
  "sectionId": "uuid",
  "scope": "section",
  "title": "Tasks",
  "tabType": "custom",
  "layoutConfig": { "view": "kanban" },
  "position": 0,
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.6 Cards**

```json
{
  "id": "uuid",
  "boardId": "uuid",
  "sectionId": "uuid",
  "tabId": "uuid",
  "type": "task",
  "title": "Implement Worker Sync",
  "content": {
    "blocks": [{ "type": "paragraph", "text": "Add background job queue." }]
  },
  "status": "open",
  "priority": 2,
  "dueDate": null,
  "tags": ["backend", "worker"],
  "assigneeId": "uuid",
  "createdBy": "uuid",
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.7 Links**

```json
{
  "id": "uuid",
  "fromCard": "uuid",
  "toCard": "uuid",
  "relType": "depends_on",
  "createdBy": "uuid",
  "createdAt": "..."
}
```

### **4.8 Tags**

```json
{
  "id": "uuid",
  "name": "urgent"
}
```

### **4.9 Rules**

```json
{
  "id": "uuid",
  "boardId": "uuid",
  "definition": {
    "trigger": "onCardUpdate",
    "condition": { "field": "title", "contains": "urgent" },
    "actions": [ { "type": "addTag", "value": "priority" } ]
  },
  "enabled": true,
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.10 Clusters**

```json
{
  "id": "uuid",
  "boardId": "uuid",
  "clusterType": "rule",
  "ruleDef": { "id": "uuid", "name": "Urgent Items" },
  "visualMeta": { "color": "red" },
  "createdAt": "...",
  "updatedAt": "..."
}
```

### **4.11 Files**

```json
{
  "id": "uuid",
  "ownerId": "uuid",
  "boardId": "uuid",
  "cardId": "uuid",
  "storageKey": "files/uuid.bin",
  "filename": "attachment.pdf",
  "mimeType": "application/pdf",
  "sizeBytes": 20000,
  "meta": { "thumbnail": null, "ocrText": null },
  "createdAt": "..."
}
```

### **4.12 Operations (Sync Log)**

```json
{
  "id": "uuid",
  "deviceId": "android-01",
  "userId": "uuid",
  "entity": "card",
  "entityId": "uuid",
  "opType": "update",
  "payload": { "status": "done" },
  "createdAt": "2025-10-24T13:00:00Z"
}
```

------

## 5) Communication Flow

```
+-----------+          +-------------+          +-----------+
|  Client   |  <====>  |  API Layer  |  <====>  | PostgreSQL|
|  (SQLite) |          | (Services)  |          | (Workers) |
+-----------+          +-------------+          +-----------+
       ↑                        ↓                       ↓
    Local ops            Generates operations       Processes background
    queued offline       → Syncs → Broadcasts       jobs and writes back
```

### Flow Summary

1. **Client** edits data locally in SQLite → creates local operation.
2. **Sync Service** uploads operations in canonical JSON to the API.
3. **API** applies valid changes to Postgres and appends new operations.
4. **Server** returns remote updates (operations) since last sync cursor.
5. **Client** applies incoming deltas locally → state converges.
6. **Workers** periodically update derived data (`clusters`, `activities`) → emit operations so clients stay in sync.

------

## 6) Internal Backend Data (Non-Sync)

| Table                   | Purpose                                                      |
| ----------------------- | ------------------------------------------------------------ |
| `auth_users`            | Authentication and role management; linked 1:1 to `users`.   |
| `worker_jobs`           | Queue of asynchronous jobs executed by background workers.   |
| `activities`            | Audit and change history (displayed via API, not persisted locally). |
| System triggers / views | Maintain timestamps, derived metrics, and worker status.     |

------

## 7) Client-Specific Local Data

| Category      | Description                                                  |
| ------------- | ------------------------------------------------------------ |
| `local_state` | Stores unsynced drafts, local UI filters, and scroll positions. |
| `fts_cards`   | Full-text search index built from card titles/content.       |
| `preferences` | Device-only user options (theme, offline retention).         |

These are **not part of sync**, but are cleared or exported separately when the app resets or backs up data.

------

## 8) Summary

- PostgreSQL serves as the **authoritative source** for all shared entities and internal systems.
- SQLite provides an **offline-first cache** of sync-eligible data only.
- Canonical JSON defines the **contract** that keeps them interoperable.
- Internal data (auth, workers, activities) remain server-only.
- Client-specific ephemeral data remains local and outside synchronization.

Together, these layers form the StickyBoard synchronization backbone — ensuring local independence, cross-device consistency, and scalable background automation.

---

```sqlite
-- ===========================================================
-- StickyBoard — SQLite Schema (Client Mirror)
-- Generated: 2025-10-24
-- ===========================================================

PRAGMA foreign_keys = ON;
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;

-- ===========================================================
-- 1. USERS
-- ===========================================================
CREATE TABLE users (
  id            TEXT PRIMARY KEY,
  email         TEXT NOT NULL,
  display_name  TEXT NOT NULL,
  avatar_uri    TEXT,
  prefs         JSON NOT NULL DEFAULT '{}',
  created_at    TEXT NOT NULL,
  updated_at    TEXT NOT NULL
);

-- ===========================================================
-- 2. BOARDS & PERMISSIONS
-- ===========================================================
CREATE TABLE boards (
  id           TEXT PRIMARY KEY,
  owner_id     TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title        TEXT NOT NULL,
  visibility   TEXT NOT NULL CHECK (visibility IN ('private','shared','public')),
  theme        JSON NOT NULL DEFAULT '{}',
  created_at   TEXT NOT NULL,
  updated_at   TEXT NOT NULL
);

CREATE TABLE permissions (
  user_id      TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  board_id     TEXT NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  role         TEXT NOT NULL CHECK (role IN ('owner','editor','commenter','viewer')),
  granted_at   TEXT NOT NULL,
  PRIMARY KEY (user_id, board_id)
);

-- ===========================================================
-- 3. STRUCTURE: SECTIONS, TABS, CARDS
-- ===========================================================
CREATE TABLE sections (
  id           TEXT PRIMARY KEY,
  board_id     TEXT NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  title        TEXT NOT NULL,
  position     INTEGER NOT NULL,
  layout_meta  JSON NOT NULL DEFAULT '{}',
  created_at   TEXT NOT NULL,
  updated_at   TEXT NOT NULL
);

CREATE TABLE tabs (
  id             TEXT PRIMARY KEY,
  board_id       TEXT NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  section_id     TEXT REFERENCES sections(id) ON DELETE SET NULL,
  scope          TEXT NOT NULL CHECK (scope IN ('board','section')),
  title          TEXT NOT NULL,
  tab_type       TEXT NOT NULL DEFAULT 'custom',
  layout_config  JSON NOT NULL DEFAULT '{}',
  position       INTEGER NOT NULL,
  created_at     TEXT NOT NULL,
  updated_at     TEXT NOT NULL
);

CREATE TABLE cards (
  id           TEXT PRIMARY KEY,
  board_id     TEXT NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  section_id   TEXT REFERENCES sections(id) ON DELETE SET NULL,
  tab_id       TEXT REFERENCES tabs(id) ON DELETE SET NULL,
  type         TEXT NOT NULL,
  title        TEXT,
  content      JSON NOT NULL DEFAULT '{}',
  ink_data     JSON,
  due_date     TEXT,
  priority     INTEGER,
  status       TEXT NOT NULL,
  created_by   TEXT REFERENCES users(id) ON DELETE SET NULL,
  assignee_id  TEXT REFERENCES users(id) ON DELETE SET NULL,
  created_at   TEXT NOT NULL,
  updated_at   TEXT NOT NULL
);

-- ===========================================================
-- 4. TAGS & LINKS
-- ===========================================================
CREATE TABLE tags (
  id     TEXT PRIMARY KEY,
  name   TEXT NOT NULL UNIQUE
);

CREATE TABLE card_tags (
  card_id TEXT NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  tag_id  TEXT NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
  PRIMARY KEY (card_id, tag_id)
);

CREATE TABLE links (
  id          TEXT PRIMARY KEY,
  from_card   TEXT NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  to_card     TEXT NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  rel_type    TEXT NOT NULL,
  created_by  TEXT REFERENCES users(id),
  created_at  TEXT NOT NULL
);

-- ===========================================================
-- 5. RULES & CLUSTERS
-- ===========================================================
CREATE TABLE rules (
  id          TEXT PRIMARY KEY,
  board_id    TEXT NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  definition  JSON NOT NULL,
  enabled     INTEGER NOT NULL DEFAULT 1,
  created_at  TEXT NOT NULL,
  updated_at  TEXT NOT NULL
);

CREATE TABLE clusters (
  id           TEXT PRIMARY KEY,
  board_id     TEXT NOT NULL REFERENCES boards(id) ON DELETE CASCADE,
  cluster_type TEXT NOT NULL,
  rule_def     JSON,
  visual_meta  JSON NOT NULL DEFAULT '{}',
  created_at   TEXT NOT NULL,
  updated_at   TEXT NOT NULL
);

CREATE TABLE cluster_members (
  cluster_id TEXT NOT NULL REFERENCES clusters(id) ON DELETE CASCADE,
  card_id    TEXT NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
  PRIMARY KEY (cluster_id, card_id)
);

-- ===========================================================
-- 6. FILES & OPERATIONS
-- ===========================================================
CREATE TABLE files (
  id           TEXT PRIMARY KEY,
  owner_id     TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  board_id     TEXT REFERENCES boards(id) ON DELETE SET NULL,
  card_id      TEXT REFERENCES cards(id) ON DELETE SET NULL,
  storage_key  TEXT NOT NULL,
  filename     TEXT NOT NULL,
  mime_type    TEXT,
  size_bytes   INTEGER,
  meta         JSON NOT NULL DEFAULT '{}',
  created_at   TEXT NOT NULL
);

CREATE TABLE operations (
  id           TEXT PRIMARY KEY,
  device_id    TEXT NOT NULL,
  user_id      TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  entity       TEXT NOT NULL,
  entity_id    TEXT NOT NULL,
  op_type      TEXT NOT NULL,
  payload      JSON NOT NULL,
  created_at   TEXT NOT NULL
);

CREATE INDEX idx_operations_time ON operations(created_at);
CREATE INDEX idx_cards_board ON cards(board_id);
CREATE INDEX idx_cards_section ON cards(section_id);
CREATE INDEX idx_sections_board ON sections(board_id);

-- ===========================================================
-- 7. FTS (Full-Text Search)
-- ===========================================================
CREATE VIRTUAL TABLE fts_cards USING fts5(
  title,
  content_text,
  tokenize = 'porter'
);

-- ===========================================================
-- 8. LOCAL STATE (Client-only helpers)
-- ===========================================================
CREATE TABLE local_state (
  key   TEXT PRIMARY KEY,
  value JSON
);

CREATE TABLE preferences (
  key   TEXT PRIMARY KEY,
  value TEXT
);

-- ===========================================================
-- End of Schema
-- ===========================================================

```

